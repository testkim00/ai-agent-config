# Analyze Orchestration

오케스트레이션 실행 보고서를 분석하여 패턴을 추출하고 학습 규칙을 업데이트합니다.

## 사용법

```
/analyze:orchestration [옵션]
```

### 옵션
- `--all`: 모든 보고서 분석 (기본값: 최근 7일)
- `--report <파일명>`: 특정 보고서만 분석

## 처리 흐름

```
┌─────────────────────────────────────────────────────────────────────┐
│ 1단계: 보고서 수집                                                   │
│        └ ~/.claude/orchestration/reports/*.json 읽기                │
├─────────────────────────────────────────────────────────────────────┤
│ 2단계: 패턴 분석                                                     │
│        ├ 병목 단계 식별                                              │
│        ├ 실패/성공 패턴 추출                                         │
│        └ 작업 유형별 통계                                            │
├─────────────────────────────────────────────────────────────────────┤
│ 3단계: 규칙 추출                                                     │
│        ├ 빈도 2회 이상 패턴 → 규칙 후보                               │
│        └ 기존 규칙과 비교                                            │
├─────────────────────────────────────────────────────────────────────┤
│ 4단계: 분석 결과 보고 (아래 템플릿)                                   │
│        └ 인사이트, 새 패턴, 규칙 후보, 변경 사항 출력                 │
├─────────────────────────────────────────────────────────────────────┤
│ 5단계: 업데이트 승인 요청                                            │
│        └ "업데이트 하시겠습니까?" → 승인 시 파일 업데이트             │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 분석 결과 보고 템플릿 (4단계)

분석 완료 후, 업데이트 전에 **반드시** 아래 형식으로 보고합니다.

```
═══════════════════════════════════════════════════════════════════════════════
                     오케스트레이션 분석 보고서
═══════════════════════════════════════════════════════════════════════════════

■ 분석 대상
│ 보고서 수: {N}개
│ 기간: {시작일} ~ {종료일}
│ 신규 보고서: {N}개 (마지막 분석 이후)

═══════════════════════════════════════════════════════════════════════════════
                              인사이트
═══════════════════════════════════════════════════════════════════════════════

■ 병목 분석
┌───────────────────┬───────────┬──────┬───────────────────────────────────────┐
│ 단계              │ 평균 비율 │ 빈도 │ 상태                                  │
├───────────────────┼───────────┼──────┼───────────────────────────────────────┤
│ stage_1_analysis  │    10%    │  13  │ 🟢 정상                               │
│ stage_2_collection│    45%    │  13  │ 🔴 병목 - 정보 수집 단계 최적화 필요  │
│ stage_3_planning  │    15%    │  13  │ 🟢 정상                               │
│ stage_4_execution │    25%    │  13  │ 🟡 주의 - 실행 시간 모니터링 권장     │
│ stage_5_report    │     5%    │  13  │ 🟢 정상                               │
└───────────────────┴───────────┴──────┴───────────────────────────────────────┘

■ 핵심 인사이트
│ 1. {인사이트 내용}
│    → 근거: {보고서명} 외 {N}건
│
│ 2. {인사이트 내용}
│    → 근거: {보고서명} 외 {N}건

═══════════════════════════════════════════════════════════════════════════════
                           새로 발견된 패턴
═══════════════════════════════════════════════════════════════════════════════

■ 성공 패턴 (효율적으로 완료된 작업)
┌─────────────────────────────────────────────────────────────────────────────┐
│ ID: pattern-new-001                                                         │
│ 설명: {패턴 설명}                                                            │
│ 빈도: {N}회                                                                  │
│ 영향: {성능/시간 영향}                                                       │
│ 출처: {보고서명 목록}                                                        │
└─────────────────────────────────────────────────────────────────────────────┘

■ 실패/문제 패턴
┌─────────────────────────────────────────────────────────────────────────────┐
│ ID: pattern-new-002                                                         │
│ 설명: {패턴 설명}                                                            │
│ 빈도: {N}회                                                                  │
│ 원인: {추정 원인}                                                            │
│ 출처: {보고서명 목록}                                                        │
└─────────────────────────────────────────────────────────────────────────────┘

■ 최적화 기회
│ 1. {최적화 제안}
│ 2. {최적화 제안}

═══════════════════════════════════════════════════════════════════════════════
                           규칙 변경 후보
═══════════════════════════════════════════════════════════════════════════════

■ 신규 규칙 후보 ({N}개)
┌─────────────────────────────────────────────────────────────────────────────┐
│ [NEW] rule-XXX: {규칙명}                                                    │
│ ├─ 조건: {trigger.condition}                                                │
│ ├─ 적용 단계: {trigger.stage}                                               │
│ ├─ 액션: {action}                                                           │
│ ├─ 우선순위: {priority}                                                     │
│ └─ 근거: {빈도}회 반복, {보고서명}                                           │
└─────────────────────────────────────────────────────────────────────────────┘

■ 갱신 규칙 후보 ({N}개)
┌─────────────────────────────────────────────────────────────────────────────┐
│ [UPDATE] rule-001: {규칙명}                                                 │
│ ├─ 변경: frequency {이전} → {이후}                                          │
│ └─ 사유: {변경 사유}                                                        │
└─────────────────────────────────────────────────────────────────────────────┘

■ 삭제 규칙 후보 ({N}개)
│ [DELETE] rule-XXX: {규칙명}
│ └─ 사유: {삭제 사유 - 예: 30일 이상 미적용}

═══════════════════════════════════════════════════════════════════════════════
                           업데이트 예정 파일
═══════════════════════════════════════════════════════════════════════════════

│ 파일                          │ 변경 내용                                    │
├───────────────────────────────┼──────────────────────────────────────────────┤
│ insights/patterns.json        │ 패턴 {N}개 추가, {N}개 갱신                  │
│ insights/patterns.md          │ 위 내용 반영                                 │
│ memory/learnings.json         │ 규칙 {N}개 추가, {N}개 갱신, {N}개 삭제      │
│ memory/learnings.md           │ 위 내용 반영                                 │

═══════════════════════════════════════════════════════════════════════════════
```

---

## 5단계: 업데이트 승인 요청

보고서 출력 후 사용자에게 질문합니다:

```
위 내용으로 학습 규칙을 업데이트하시겠습니까?

- 업데이트 진행: patterns.json, learnings.json 등 갱신
- 취소: 변경 없이 종료
```

승인 시에만 파일을 업데이트합니다.

---

## 분석 항목 상세

### 1. 병목 분석
- 각 단계별 소요 시간 비율
- 가장 오래 걸린 단계 식별
- 병목 원인 추정

### 2. 패턴 추출
- **성공 패턴**: 효율적으로 완료된 작업의 공통점
- **실패 패턴**: 문제가 발생한 작업의 공통점
- **최적화 패턴**: 개선이 가능한 영역

### 3. 규칙 생성 기준
- 빈도 2회 이상 반복된 패턴 → 규칙으로 승격
- 30일 이상 미적용 규칙 → 삭제 후보
- 규칙 형식:
  ```json
  {
    "id": "rule-XXX",
    "name": "규칙명",
    "trigger": { "condition": "조건", "stage": "적용 단계" },
    "action": "수행할 작업",
    "priority": "high|medium|low",
    "frequency": 횟수
  }
  ```

---

## 실행 예시

```bash
# 최근 7일 보고서 분석 → 보고 → 승인 요청
/analyze:orchestration

# 모든 보고서 분석
/analyze:orchestration --all

# 특정 보고서만 분석
/analyze:orchestration --report 2026-01-22_refactoring-report.json
```

---

## 관련 파일

| 파일 | 용도 |
|------|------|
| `~/.claude/orchestration/reports/*.json` | 원본 보고서 |
| `~/.claude/orchestration/insights/patterns.json` | 패턴 분석 결과 (JSON) |
| `~/.claude/orchestration/insights/patterns.md` | 패턴 분석 결과 (MD) |
| `~/.claude/orchestration/memory/learnings.json` | 학습 규칙 (JSON) |
| `~/.claude/orchestration/memory/learnings.md` | 학습 규칙 (MD) |

---

## 자동화 권장 시점

- 오케스트레이션 5단계 완료 후
- 주간 정기 분석 (매주 월요일)
- 보고서 10개 이상 누적 시

---

## 업데이트 로직 (승인 시 적용)

### 1. patterns.json 업데이트 로직

```
┌─────────────────────────────────────────────────────────────────────┐
│ 1. 보고서에서 패턴 추출                                              │
│    ├ 병목: stage별 소요시간 비율 30% 초과 → bottlenecks에 추가       │
│    ├ 실패: error 또는 failed 상태 → failure_patterns에 추가         │
│    └ 성공: 평균보다 빠른 완료 → success_patterns에 추가              │
├─────────────────────────────────────────────────────────────────────┤
│ 2. 기존 패턴과 병합                                                  │
│    ├ 동일 패턴 존재 → frequency +1, last_seen 갱신                  │
│    └ 신규 패턴 → 새 ID 부여하여 추가                                 │
├─────────────────────────────────────────────────────────────────────┤
│ 3. 작업 유형별 통계 갱신                                             │
│    └ task_type_insights 섹션 업데이트                               │
└─────────────────────────────────────────────────────────────────────┘
```

### 2. learnings.json 업데이트 로직

```
┌─────────────────────────────────────────────────────────────────────┐
│ 1. 규칙 승격 (patterns → rules)                                     │
│    ├ 조건: frequency >= 2 (meta.min_frequency_for_rule)             │
│    ├ 패턴에서 trigger.condition, trigger.stage 추출                 │
│    └ action 자동 생성 또는 패턴 설명에서 도출                        │
├─────────────────────────────────────────────────────────────────────┤
│ 2. 기존 규칙 갱신                                                    │
│    ├ 동일 규칙 존재 → frequency 합산, last_applied 갱신             │
│    └ 30일 미적용 규칙 → 삭제 후보로 표시                             │
├─────────────────────────────────────────────────────────────────────┤
│ 3. 통계 갱신                                                         │
│    └ statistics 섹션 (총 오케스트레이션 수, 성공률 등)               │
└─────────────────────────────────────────────────────────────────────┘
```

### 3. 우선순위 결정 로직

| 조건 | 우선순위 |
|------|----------|
| 빌드 실패/보안 관련 | 🔴 high |
| 성능 30% 이상 영향 | 🔴 high |
| 반복 빈도 5회 이상 | 🟡 medium |
| 코드 품질/스타일 | 🟢 low |
| 기타 최적화 | 🟢 low |

### 4. MD 파일 생성 로직

```
┌─────────────────────────────────────────────────────────────────────┐
│ JSON → MD 변환                                                       │
├─────────────────────────────────────────────────────────────────────┤
│ patterns.json → patterns.md                                          │
│ ├ bottlenecks → "## 병목 패턴" 섹션                                  │
│ ├ failure_patterns → "## 실패 패턴" 섹션                             │
│ ├ success_patterns → "## 성공 패턴" 섹션                             │
│ └ task_type_insights → "## 작업 유형별 인사이트" 섹션                │
├─────────────────────────────────────────────────────────────────────┤
│ learnings.json → learnings.md                                        │
│ ├ rules (high) → "### 🔴 High Priority" 섹션                        │
│ ├ rules (medium) → "### 🟡 Medium Priority" 섹션                    │
│ ├ rules (low) → "### 🟢 Low Priority" 섹션                          │
│ └ statistics → "## 통계" 테이블                                      │
└─────────────────────────────────────────────────────────────────────┘
```

### 5. 업데이트 흐름 요약

```
보고서 분석
    │
    ▼
패턴 추출 (병목/실패/성공)
    │
    ▼
patterns.json 병합
    │
    ▼
frequency >= 2 패턴 → 규칙 승격
    │
    ▼
learnings.json 갱신
    │
    ▼
MD 파일 동기화 (JSON → MD)
    │
    ▼
완료
```


ARGUMENTS: $ARGUMENTS
