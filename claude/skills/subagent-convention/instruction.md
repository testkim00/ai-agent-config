# Subagent Convention

## 위임 체계

```
오케스트레이터 (Opus)
    │ 세분화된 작업 위임
    ▼
감독관 (Opus subagent)
    │ 단순 반복 업무 위임
    ▼
실행자 (Sonnet subagent)
```

**계획 단계 전용:**
- Setter (Sonnet) - 정보 수집 + 역할 설명
- Advisor (Codex) - 계획 검토, 전문 분야 자문

## 역할 요약

| 대상 | 모델 | 역할 |
|------|------|------|
| Orchestrator | Opus | 요청 분석, 목표 설정, 정보 분석, 상세 계획 수립, 시간 기록 |
| Setter | Sonnet subagent | 정보 수집 (수집 + 역할 설명) |
| Advisor | Codex | 계획 검토 (계획 단계만) |
| Supervisor | Opus subagent | 작업 책임, 검수, 재위임 |
| Executor | Sonnet subagent | 단순 반복 실행 |
| Analyzer | Sonnet subagent | 실행 시간 분석, 병목 탐지, 보고서 생성 |

## 작업 흐름 (5단계)

```
┌─────────────────────────────────────────────────────────────────────┐
│ 1단계: 요청 분석 및 목표 설정                    ⏱️ 시간 기록 시작   │
│        ├ 1-1. 요청 내용/의도 파악                                   │
│        ├ 1-2. 필수 정보 간략 확인 (CLAUDE.md 등)                    │
│        ├ 1-3. 목표 설정 및 성공 기준 정의                           │
│        ├ 1-4. 목표 달성 계획안 작성                                 │
│        └ 1-5. 정보 수집 목록 작성                                   │
├─────────────────────────────────────────────────────────────────────┤
│ 2단계: 정보 수집                                 ⏱️ 각 호출별 기록   │
│        ├ 2-1. 프로젝트 전체 구조 수집                               │
│        ├ 2-2. 요청 항목 상세 수집                                   │
│        ├ 2-3. 의존성 확인                                          │
│        └ 2-4. 각 파일/폴더 역할 설명                                │
├─────────────────────────────────────────────────────────────────────┤
│ 3단계: 정보 분석 및 상세 계획 수립               ⏱️ 분석 시간 기록   │
│        ├ 3-1. 수집 정보 분석                                       │
│        ├ 3-2. 추가 정보 필요 여부 판단 (→ 2단계 반복)               │
│        ├ 3-3. 상세 실행 계획 수립                                   │
│        └ 3-4. Advisor 계획 검토 (선택)                              │
├─────────────────────────────────────────────────────────────────────┤
│ 4단계: 실행                                      ⏱️ 각 작업별 기록   │
│        ├ 4-1. Supervisor에게 작업 분배                              │
│        ├ 4-2. Executor 실행 (병렬/순차)                             │
│        └ 4-3. 결과 검수 및 취합                                     │
├─────────────────────────────────────────────────────────────────────┤
│ 5단계: 실행 분석 보고                            📊 보고서 출력      │
│        ├ 5-1. 시간 기록 취합                                       │
│        ├ 5-2. 병목 단계 식별                                       │
│        ├ 5-3. 병목 원인 분석 (담당자 인터뷰 또는 직접 분석)          │
│        ├ 5-4. 보고서 생성 (콘솔 + JSON)                             │
│        └ 5-5. 개선 제안                                            │
└─────────────────────────────────────────────────────────────────────┘
```

## 1단계: 요청 분석

Setter 호출 **전에** 수행:

1. **요청 내용/의도 파악** - 사용자가 원하는 것 명확히 정의
2. **필수 정보 간략 확인** - CLAUDE.md, README.md, 프로젝트 구조
3. **목표 설정** - 최종 목표 정의, 성공 기준 명시
4. **목표 달성 계획안 작성** - 대략적인 접근 방식
5. **정보 수집 목록 작성** - Setter에게 전달할 구체적 항목

## 2단계: 정보 수집 (Setter)

> **핵심: 깊은 분석 없이 수집 + 역할 설명**

- 프로젝트 전체 파일 구조 + **각 디렉토리/파일의 역할 설명**
- Orchestrator가 요청한 항목의 상세 수집
- 관련 파일 경로 및 내용 + **기능/역할 설명**
- 의존성 확인 (참조 관계)

> **주의:** 코드 패턴 분석, 통합 방안 검토 등 깊은 분석은 하지 않음.

## 3단계: 분석 및 계획 (Orchestrator)

1. **수집 정보 분석** - 코드 패턴 파악, 기존 구조와 통합 방안
2. **추가 정보 필요 여부** - 부족 시 Setter 재호출
3. **상세 계획 수립**

### 상세 계획 포맷

```markdown
## 상세 계획

### 1. 목표
- 최종 목표: {목표}
- 성공 기준: {기준}

### 2. 작업 분할

| 작업 ID | 작업 내용 | 담당 | 의존성 | 병렬 가능 |
|---------|----------|------|--------|----------|
| T1 | {작업1} | 감독관A | 없음 | O |
| T2 | {작업2} | 감독관A | T1 | X |

### 3. 병렬 처리 전략
- 1차 병렬 (감독관 레벨): 감독관A: T1, T2 / 감독관B: T3, T4
- 2차 병렬 (실행자 레벨): 각 감독관 → 실행자 N명

### 4. 의존성 순서
T1, T2 (병렬) → T3 (순차) → T4, T5 (병렬)
```

## 4단계: 실행

### 위임 기준

| 조건 | 처리 |
|------|------|
| 단순 반복 1~2개 | 직접 실행 |
| 단순 반복 3개+ | Executor 병렬 위임 |
| 복잡한 판단 | 직접 |
| 계획 검토 | Advisor (계획 단계만) |

**병렬 실행 조건:** 의존성 없음 + 같은 파일 수정 아님

## 5단계: 실행 분석 (Analyzer) - 필수

> ⚠️ **이 단계는 선택이 아닌 필수입니다.**

### 필수 수행 항목

| 순서 | 항목 | 필수 여부 |
|------|------|----------|
| 5-1 | 시간 기록 취합 | ✅ 필수 |
| 5-2 | 병목 단계 식별 | ✅ 필수 |
| 5-3 | 병목 원인 분석 | ✅ 필수 |
| 5-4 | 콘솔 보고서 출력 | ✅ 필수 |
| 5-5 | JSON 파일 저장 | ✅ 필수 |

### 5-1. 시간 기록 (1~4단계 동안)

각 단계/작업의 시작과 종료 시간을 기록합니다:

```
[TIME] 1.0 | START | 2024-01-19 10:00:00 | 1단계: 요청 분석 시작
[TIME] 1.0 | END   | 2024-01-19 10:00:30 | 1단계: 요청 분석 완료 (30s)
[TIME] 2.1 | START | 2024-01-19 10:00:30 | Setter 호출 시작
...
```

### 5-2. 병목 판단 기준

| 비율 | 판정 |
|------|------|
| 50% 이상 | 🔴 심각한 병목 |
| 30~50% | 🟡 주의 필요 |
| 30% 미만 | 🟢 정상 |

### 5-3. 병목 원인 분석

| 병목 단계 | 담당자 | 분석 방법 |
|----------|--------|----------|
| 1단계 | Orchestrator | 직접 분석 |
| 2단계 | Setter | Setter 인터뷰 |
| 3단계 | Orchestrator | 직접 분석 |
| 4단계 | Supervisor/Executor | 담당자 인터뷰 |

**인터뷰 질문:**
- "왜 이 작업이 예상보다 오래 걸렸나요?"
- "어떤 부분에서 지연이 발생했나요?"
- "다음에 개선할 수 있는 방법이 있나요?"

### 5-4. 콘솔 보고서 출력

**템플릿:** [execution-report.md](./templates/execution-report.md)

보고서에 **반드시** 포함할 섹션:

1. **요약** - 작업명, 총 실행 시간, 파일 변경 수
2. **완료 작업 목록** - TodoWrite 기반 작업 상태
3. **변경 파일 상세** - 파일별 상태와 설명
4. **단계별 소요 시간** - 1~4단계 시간 및 비율 ⭐
5. **병목 분석** - 병목 단계, 원인, 개선 제안 ⭐
6. **개선 효과** - 카테고리별 개선 내용

### 5-5. JSON 파일 저장

**저장 경로:**
```
~/.claude/orchestration/reports/{YYYY-MM-DD}_{HH-mm-ss}.json
```

**스키마:** [analyzer.md](./templates/analyzer.md) 참조

**저장 전 디렉토리 생성:**
```bash
mkdir -p ~/.claude/orchestration/reports
```

## 호출 예시

### Setter 호출

```python
Task(
    subagent_type="Explore",
    model="sonnet",
    prompt="""
    [정보 수집 요청]
    다음 항목을 수집하세요.
    각 파일/폴더가 어떤 기능과 역할을 하는지 간단히 설명을 달아주세요.

    [수집 목록]
    1. {항목1}
    2. {항목2}

    [출력 형식]
    ## 프로젝트 구조
    | 경로 | 역할 |
    |------|------|

    ## 수집 항목 1: {항목명}
    - 경로: {파일 경로}
    - 역할: {이 파일이 하는 일}
    - 내용: {코드/설정}

    ## 의존성
    - {파일A} → {파일B}: {참조 관계}
    """
)
```

### Supervisor 호출

```python
Task(
    subagent_type="general-purpose",
    model="opus",
    prompt="""
    [작업 ID]: T1
    [작업]: {작업 내용}
    [담당 파일]: {파일 목록}
    [권한]: 단순 반복은 실행자(sonnet) 위임 가능
    """
)
```

### Executor 병렬 호출

```python
# 한 메시지에 여러 Task = 병렬 실행
Task(model="sonnet", prompt="파일A 수정: ...")
Task(model="sonnet", prompt="파일B 수정: ...")
Task(model="sonnet", prompt="파일C 수정: ...")
```

### Analyzer 호출

```python
Task(
    subagent_type="general-purpose",
    model="sonnet",
    prompt="""
    [실행 분석 요청]
    시간 기록을 분석하고 보고서를 생성하세요.

    [시간 기록]
    {time_logs}

    [출력]
    1. 콘솔 보고서 (템플릿 참조)
    2. JSON 파일 저장: ~/.claude/orchestration/reports/{timestamp}.json
    """
)
```

## 핵심 원칙

1. Orchestrator는 Setter 호출 전에 먼저 요청 분석 및 목표 설정
2. Setter는 **수집 + 역할 설명**, 깊은 분석은 Orchestrator가 수행
3. 정보 부족 시 Setter 반복 호출
4. Advisor는 계획 단계에서만 사용 (실행 단계 금지)
5. 감독관은 책임지고 검수
6. 실행자는 판단 없이 실행만
7. subagent 생성 비용 > 실행 비용이면 직접 처리
8. **모든 단계/작업의 시작과 종료 시간을 기록**
9. **실행 완료 후 반드시 분석 보고서 출력**

## 템플릿

| 템플릿 | 용도 |
|--------|------|
| `setter.md` | 정보 수집 |
| `executor.md` | git, shell 명령 |
| `file-processor.md` | 파일 처리 |
| `analyzer.md` | 실행 시간 분석, JSON 보고서 스키마 |
| `execution-report.md` | **콘솔 결과 보고서 출력 (5단계 필수)** |

## 참고

- 설정: [config.md](./config.md)
- 템플릿: [templates/](./templates/)
