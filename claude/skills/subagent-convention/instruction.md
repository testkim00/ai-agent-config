# Subagent Convention

## 3계층 위임 체계

```
┌─────────────────────────────────────────────────────────────┐
│  오케스트레이터 (Opus 직접)                                   │
│                                                             │
│  [역할]                                                      │
│  - 사용자와 소통                                             │
│  - 문제 분석 및 계획 수립                                    │
│  - 복잡한 작업을 병렬 처리 가능하도록 세분화                  │
│  - 감독관에게 작업 위임                                      │
│  - 최종 결과 취합 및 사용자에게 보고                         │
└─────────────────┬───────────────────────────────────────────┘
                  │ 세분화된 작업 위임 (병렬 가능)
                  ▼
┌─────────────────────────────────────────────────────────────┐
│  감독관 (Opus subagent)                                      │
│                                                             │
│  [역할]                                                      │
│  - 위임받은 작업에 대한 책임                                 │
│  - 기본적으로 직접 처리                                      │
│  - 단순 반복 업무는 실행자에게 재위임                        │
│  - 큰 업무는 여러 실행자를 병렬 호출                         │
│  - 실행자 결과물 검수                                        │
│  - 오케스트레이터에게 결과 보고                              │
└─────────────────┬───────────────────────────────────────────┘
                  │ 단순 반복 업무 위임 (병렬 가능)
                  ▼
┌─────────────────────────────────────────────────────────────┐
│  실행자 (Sonnet subagent)                                    │
│                                                             │
│  [역할]                                                      │
│  - 맡은 파트만 수행                                          │
│  - 단순 반복 업무를 빠르게 처리                              │
│  - 결과를 감독관에게 보고                                    │
│  - 판단/결정 X, 실행만                                       │
└─────────────────────────────────────────────────────────────┘

        ┌─────────────────────┐
        │  Codex (자문)        │  ← 어느 계층에서든 호출 가능
        │  - 계획 검토         │
        │  - 전문 분야 자문    │
        │  - 외부 정보 조회    │
        └─────────────────────┘
```

## 역할 상세

### 오케스트레이터 (Opus 직접)

| 항목 | 설명 |
|------|------|
| **모델** | Opus (subagent 아님, 직접 실행) |
| **핵심 역할** | 총괄 기획자 |
| **소통** | 사용자와 직접 대화 |
| **분석** | 요청 분석, 복잡도 판단 |
| **계획** | 작업 세분화, 의존성 분석, 병렬화 설계 |
| **위임** | 감독관에게 독립적인 작업 단위로 배분 |
| **취합** | 감독관들의 결과를 모아 최종 결과 생성 |

**언제 감독관을 호출하는가?**
- 작업이 크고 복잡해서 병렬 처리가 필요할 때
- 독립적으로 진행 가능한 작업 단위가 있을 때
- 단순 작업 1~2개는 직접 처리 또는 실행자 직접 호출

**위임 전 Codex 자문 (필수)**
- 감독관에게 위임할 정도의 복잡한 작업이면 **Codex에게 계획 검토 요청**
- 작업 세분화, 의존성 분석, 병렬화 전략에 대한 피드백 수렴
- 자문 후 계획 확정 → 감독관에게 위임

### 감독관 (Opus subagent)

| 항목 | 설명 |
|------|------|
| **모델** | Opus (subagent) |
| **핵심 역할** | 중간 관리자, 작업 책임자 |
| **책임** | 위임받은 작업의 완수 |
| **처리** | 기본적으로 직접 수행 |
| **재위임** | 단순 반복은 실행자에게 위임 |
| **검수** | 실행자 결과물 품질 확인 |
| **보고** | 오케스트레이터에게 결과 보고 |

**언제 실행자를 호출하는가?**
- 단순 반복 업무가 3개 이상일 때
- 패턴이 동일한 작업이 여러 개일 때
- 판단이 필요 없는 기계적 작업일 때

### 실행자 (Sonnet/Haiku subagent)

| 항목 | 설명 |
|------|------|
| **모델** | Sonnet 또는 Haiku |
| **핵심 역할** | 실행자 |
| **범위** | 맡은 파트만 수행 |
| **목적** | 단순 반복 업무를 빠르게 처리 |
| **판단** | 하지 않음 (지시대로만 실행) |
| **보고** | 감독관에게 결과 보고 |

**Sonnet vs Haiku 선택 기준:**

| 모델 | 용도 | 예시 |
|------|------|------|
| **Sonnet** | 약간의 맥락 이해 필요 | 코드 수정, 파일 변환 |
| **Haiku** | 완전 단순 반복 | 파일 복사, 텍스트 치환, 포맷 변경 |

## 위임 흐름 예시

### 예시: 10개 파일 리팩토링

```
[사용자 요청]
"src/api 폴더의 10개 파일에서 에러 핸들링을 통일해줘"

[오케스트레이터]
1. 요청 분석: 10개 파일, 독립적 작업, 병렬 가능
2. 계획 수립: 파일을 3~4개씩 묶어서 감독관에게 분배
3. 감독관 3명에게 병렬 위임

[감독관 A] (파일 1~3 담당)
1. 작업 분석: 3개 파일, 패턴 동일, 단순 반복
2. 실행자 3명 병렬 호출
3. 결과 검수
4. 오케스트레이터에게 보고

[실행자 1]
1. 파일 1 에러 핸들링 수정
2. 결과 보고

[오케스트레이터]
1. 감독관들의 결과 취합
2. 사용자에게 최종 보고
```

## 호출 방법

### 오케스트레이터 → 감독관

```python
# 병렬 호출 (한 메시지에 여러 Task)
Task(
    subagent_type="general-purpose",
    model="opus",
    prompt="""
    [작업]: API 엔드포인트 리팩토링
    [담당 파일]: users.py, orders.py, products.py
    [목표]: 에러 핸들링 통일
    [권한]: 단순 반복 작업은 실행자(sonnet) 위임 가능
    [보고]: 완료 후 결과 요약
    """
)
```

### 감독관 → 실행자

```python
# 병렬 호출 (한 메시지에 여러 Task)
Task(model="sonnet", prompt="users.py 에러 핸들링 수정: ...")
Task(model="sonnet", prompt="orders.py 에러 핸들링 수정: ...")
Task(model="sonnet", prompt="products.py 에러 핸들링 수정: ...")
```

## 핵심 원칙

1. **오케스트레이터**는 계획하고 분배한다
2. **감독관**은 책임지고 검수한다
3. **실행자**는 빠르게 실행만 한다
4. **병렬화**는 각 계층에서 가능하다
5. **subagent 생성 비용 > 실행 비용**이면 직접 처리

## Codex 자문

어느 계층에서든 필요시 Codex에게 자문 요청 가능:

```bash
# 계획 검토
codex exec "이 리팩토링 계획 검토해줘: ..." --full-auto

# 전문 지식
codex exec "React 18 best practice" --sandbox danger-full-access
```

## 참고

- 설정: [config.md](./config.md)
- 템플릿: [templates/](./templates/)
