# Subagent Convention

## 4계층 위임 체계

```
┌─────────────────────────────────────────────────────────────┐
│  오케스트레이터 (Opus 직접)                                   │
│                                                             │
│  [역할]                                                      │
│  - 사용자와 소통                                             │
│  - 문제 분석 및 상세 계획 수립                               │
│  - 복잡한 작업을 병렬 처리 가능하도록 세분화                  │
│  - 감독관에게 작업 위임                                      │
│  - 최종 결과 취합 및 사용자에게 보고                         │
└─────────────────┬───────────────────────────────────────────┘
                  │ 세분화된 작업 위임 (병렬 가능)
                  ▼
┌─────────────────────────────────────────────────────────────┐
│  감독관 (Opus subagent)                                      │
│                                                             │
│  [역할]                                                      │
│  - 위임받은 작업에 대한 책임                                 │
│  - 기본적으로 직접 처리                                      │
│  - 단순 반복 업무는 실행자에게 재위임                        │
│  - 큰 업무는 여러 실행자를 병렬 호출                         │
│  - 실행자 결과물 검수                                        │
│  - 오케스트레이터에게 결과 보고                              │
└─────────────────┬───────────────────────────────────────────┘
                  │ 단순 반복 업무 위임 (병렬 가능)
                  ▼
┌─────────────────────────────────────────────────────────────┐
│  실행자 (Sonnet subagent)                                    │
│                                                             │
│  [역할]                                                      │
│  - 맡은 파트만 수행                                          │
│  - 단순 반복 업무를 빠르게 처리                              │
│  - 결과를 감독관에게 보고                                    │
│  - 판단/결정 X, 실행만                                       │
└─────────────────────────────────────────────────────────────┘

┌───────────────────────────────────────────────────────────────────────┐
│  계획 수립 단계 전용 도구                                              │
├───────────────────────────────────────────────────────────────────────┤
│                                                                       │
│  ┌─────────────────────┐     ┌─────────────────────┐                 │
│  │  Setter (정보 수집)  │     │  Advisor (자문)      │                 │
│  │  - 파일 경로 탐색    │     │  - 계획 검토         │                 │
│  │  - API 엔드포인트    │     │  - 전문 분야 자문    │                 │
│  │  - 기존 패턴 파악    │     │  [도구: Codex]       │                 │
│  │  - 의존성 확인       │     │                      │                 │
│  └─────────────────────┘     └─────────────────────┘                 │
│                                                                       │
│  ⚠️ Advisor는 계획 수립 단계에서만 호출 가능 (실행 단계 사용 금지)     │
└───────────────────────────────────────────────────────────────────────┘
```

## 위임 체계

| 대상 | 모델 | 역할 | 특징 |
|------|------|------|------|
| **Orchestrator** | Opus | 오케스트레이션 | 상세 계획 수립, 검토, 복잡한 판단 |
| **Setter** | Sonnet | 정보 수집 | 파일 경로, API 주소, 문서 등 세팅 |
| **Advisor** | - | 자문 | 계획 검토 전용 (도구: Codex) |
| **Supervisor** | Opus (subagent) | 중간 관리 | 작업 책임, 검수, 재위임 |
| **Executor** | Sonnet | 실행 | 단순 반복 작업 |

## 작업 흐름

```
[전체 흐름]

┌─────────────────────────────────────────────────────────────────────┐
│  1. 계획 수립 단계                                                   │
│                                                                      │
│  사용자 요청                                                         │
│       ↓                                                              │
│  Setter (1차 정보 수집)                                              │
│       ↓                                                              │
│  Orchestrator (초안 계획 수립)                                       │
│       ↓                                                              │
│  ┌─ 추가 정보 필요? ─┐                                              │
│  │  YES → Setter (추가 정보 수집) → 계획 보완                        │
│  │  NO  → 다음 단계                                                  │
│  └───────────────────┘                                              │
│       ↓                                                              │
│  Advisor (계획 검토) ← 복잡한 작업인 경우만                          │
│       ↓                                                              │
│  Orchestrator (상세 계획 확정)                                       │
└─────────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────────┐
│  2. 실행 단계                                                        │
│                                                                      │
│  Supervisor (작업 관리) ← 상세 계획에 따라 위임                      │
│       ↓                                                              │
│  Executor (실행) ← 병렬 처리                                         │
│       ↓                                                              │
│  결과 취합 및 보고                                                   │
└─────────────────────────────────────────────────────────────────────┘
```

## 상세 계획 수립 (핵심)

> **오케스트레이터는 Setter가 수집한 정보를 바탕으로 상세 계획을 수립한다.**

### Setter와의 협력

1. **1차 정보 수집**: Setter에게 기본 정보 수집 요청
2. **계획 초안 작성**: 수집된 정보로 초안 작성
3. **추가 정보 요청**: 계획 수립 중 부족한 정보는 Setter에게 재요청
4. **정보 정리 요청**: 복잡한 정보는 Setter에게 정리 요청

```python
# Setter 호출 예시 - 추가 정보 요청
Task(
    subagent_type="Explore",
    model="sonnet",
    prompt="""
    [추가 정보 요청]

    기존 수집 정보: {기존 정보 요약}
    추가로 필요한 정보:
    - {필요한 정보 1}
    - {필요한 정보 2}

    [출력 형식]
    - 요청한 정보만 간결하게 정리
    """
)
```

### 상세 계획 포맷

상세 계획에는 반드시 다음 내용이 포함되어야 한다:

```markdown
## 상세 계획

### 1. 목표
- 최종 목표: {목표}
- 성공 기준: {기준}

### 2. 작업 분할

| 작업 ID | 작업 내용 | 담당 | 의존성 | 병렬 가능 |
|---------|----------|------|--------|----------|
| T1 | {작업1} | 감독관A | 없음 | ✅ |
| T2 | {작업2} | 감독관A | 없음 | ✅ |
| T3 | {작업3} | 감독관B | T1 | ❌ |

### 3. 병렬 처리 전략

**1차 병렬 (감독관 레벨)**
- 감독관A: T1, T2 담당
- 감독관B: T4, T5 담당

**2차 병렬 (실행자 레벨)**
- 감독관A → 실행자 3명 병렬 (파일 1~3 각각)
- 감독관B → 실행자 2명 병렬 (파일 4~5 각각)

### 4. 위임 범위

| 계층 | 위임 내용 | 권한 |
|------|----------|------|
| 감독관 | 작업 단위 (T1~T5) | 실행자 재위임 가능 |
| 실행자 | 파일 단위 수정 | 실행만, 판단 X |

### 5. 의존성 및 순서

```
T1, T2 (병렬) → T3 (순차) → T4, T5 (병렬)
```

### 6. 예상 위험 및 대응

| 위험 | 대응 |
|------|------|
| {위험1} | {대응1} |
```

### 계획 수립 체크리스트

- [ ] 작업이 명확하게 분할되었는가?
- [ ] 각 작업의 담당자가 지정되었는가?
- [ ] 의존성이 파악되었는가?
- [ ] 병렬 처리 가능한 작업이 식별되었는가?
- [ ] 감독관/실행자 위임 범위가 명확한가?
- [ ] 추가 정보가 필요하지 않은가?

## Advisor (자문) - 계획 수립 단계 전용

> ⚠️ **Advisor는 계획 수립 단계에서만 사용 가능. 실행 단계에서는 호출 금지.**

### 언제 사용하는가?

- 감독관에게 위임할 정도의 복잡한 작업
- 작업 세분화 전략이 불확실할 때
- 병렬화 전략 검토가 필요할 때
- 아키텍처 결정이 필요할 때

### 자문 요청 예시

```bash
codex exec "다음 상세 계획을 검토해줘:

## 목표
{목표}

## 작업 분할
{작업 분할 테이블}

## 병렬 처리 전략
{병렬 전략}

## 질문
1. 작업 분할이 적절한가?
2. 병렬 처리 범위가 적절한가?
3. 누락된 작업이 있는가?
4. 위험 요소는?

개선점이 있으면 구체적으로 제안해줘" --full-auto
```

## 감독관 역할

| 항목 | 설명 |
|------|------|
| **모델** | Opus (subagent) |
| **핵심 역할** | 중간 관리자, 작업 책임자 |
| **책임** | 위임받은 작업의 완수 |
| **처리** | 기본적으로 직접 수행 |
| **재위임** | 단순 반복은 실행자에게 위임 |
| **검수** | 실행자 결과물 품질 확인 |
| **보고** | 오케스트레이터에게 결과 보고 |

**언제 실행자를 호출하는가?**
- 단순 반복 업무가 3개 이상일 때
- 패턴이 동일한 작업이 여러 개일 때
- 판단이 필요 없는 기계적 작업일 때

## 위임 기준

### 유형별

| 유형 | 처리 |
|------|------|
| 단순 반복 | ✅ Executor (Sonnet) |
| 복잡한 판단 | ❌ 직접 |
| 계획 검토 | ✅ Advisor (계획 단계만) |
| 중간 관리/검수 | ✅ Supervisor (Opus subagent) |

### 작업량별

> subagent 생성 비용 > 실행 비용이면 직접 처리

| 작업량 | 처리 |
|--------|------|
| 1~2개 | 직접 실행 |
| 3개 이상 | 병렬 위임 |

## 병렬 실행

### 조건

| 조건 | 병렬 |
|------|------|
| 의존성 없음 | ✅ |
| 결과 의존 | ❌ |
| 같은 파일 수정 | ❌ |

### 방법

```python
# 한 메시지에 여러 Task = 병렬
Task(model="sonnet", prompt="작업 A")
Task(model="sonnet", prompt="작업 B")
```

## 호출 방법

### 오케스트레이터 → 감독관

```python
# 병렬 호출 (한 메시지에 여러 Task)
Task(
    subagent_type="general-purpose",
    model="opus",
    prompt="""
    [작업 ID]: T1
    [작업]: API 엔드포인트 리팩토링
    [담당 파일]: users.py, orders.py, products.py
    [목표]: 에러 핸들링 통일
    [권한]: 단순 반복 작업은 실행자(sonnet) 위임 가능
    [의존성]: 없음
    [보고]: 완료 후 결과 요약
    """
)
```

### 감독관 → 실행자

```python
# 병렬 호출 (한 메시지에 여러 Task)
Task(model="sonnet", prompt="users.py 에러 핸들링 수정: ...")
Task(model="sonnet", prompt="orders.py 에러 핸들링 수정: ...")
Task(model="sonnet", prompt="products.py 에러 핸들링 수정: ...")
```

## 핵심 원칙

1. **오케스트레이터**는 상세 계획을 수립하고 분배한다
2. **Setter**와 반복 협력하여 필요한 정보를 확보한다
3. **Advisor**는 계획 수립 단계에서만 사용한다 (실행 단계 금지)
4. **감독관**은 책임지고 검수한다
5. **실행자**는 빠르게 실행만 한다
6. **병렬화**는 상세 계획에 명시된 대로 실행한다
7. **subagent 생성 비용 > 실행 비용**이면 직접 처리

## 템플릿

| 템플릿 | 용도 |
|--------|------|
| `setter.md` | 정보 수집 |
| `executor.md` | git, shell 명령 |
| `file-processor.md` | 파일 처리 |
| `api-caller.md` | API 호출 |
| `codex-caller.md` | Codex 호출 (계획 단계만) |

## 참고

- 설정: [config.md](./config.md)
- 템플릿: [templates/](./templates/)
