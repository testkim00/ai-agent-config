# Subagent Convention

## 시작 전 필수 확인

```
┌─────────────────────────────────────────────────────────────┐
│ 오케스트레이션 시작 시 반드시:                               │
│                                                             │
│ 1. _index.md 확인 (관련 문서 파악)                          │
│ 2. 이 파일(instruction.md) 읽기                             │
│ 3. 1단계 시작과 동시에 시간 기록 시작                        │
│    [TIME] 1.0 | START | {timestamp} | 1단계: 요청 분석 시작 │
└─────────────────────────────────────────────────────────────┘
```

## 완료 조건

```
┌─────────────────────────────────────────────────────────────┐
│ 다음 조건을 모두 충족해야 완료:                              │
│                                                             │
│ ✅ 1~4단계 실행 완료                                        │
│ ✅ 5단계 실행 분석 보고 완료                                │
│    - 콘솔 보고서 출력                                       │
│    - JSON 파일 저장 (~/.claude/orchestration/reports/)      │
│                                                             │
│ ❌ 5단계 미수행 시 오케스트레이션 미완료로 간주              │
└─────────────────────────────────────────────────────────────┘
```

## 실행 원칙

```
┌─────────────────────────────────────────────────────────────┐
│ 단계 간 사용자 확인 없이 연속 진행                           │
│                                                             │
│ - 1단계 완료 → 바로 2단계 시작                              │
│ - 2단계 완료 → 바로 3단계 시작                              │
│ - ...                                                       │
│ - 5단계 보고서 출력 후 종료                                 │
│                                                             │
│ 타임스탬프만 기록하고 즉시 다음 단계로 진행                  │
└─────────────────────────────────────────────────────────────┘
```

## 위임 체계

```
오케스트레이터 (Opus)
    │ 세분화된 작업 위임
    ▼
감독관 (Opus subagent)
    │ 단순 반복 업무 위임
    ▼
실행자 (Sonnet subagent)
```

**계획 단계 전용:**
- Setter (Sonnet) - 정보 수집 + 역할 설명
- Advisor (Codex) - 계획 검토, 전문 분야 자문

## 역할 요약

| 역할 | 모델 | 책임 |
|------|------|------|
| Orchestrator | Opus | 요청 분석, 목표 설정, 정보 분석, 계획 수립 |
| Setter | Sonnet | 정보 수집 (수집 + 역할 설명) |
| Advisor | Codex | 계획 검토 (계획 단계만) |
| Supervisor | Opus subagent | 작업 책임, 검수, 재위임 |
| Executor | Sonnet subagent | 단순 반복 실행 |
| Analyzer | Sonnet subagent | 시간 분석, 병목 탐지, 보고서 |

## 작업 흐름 (5단계)

```
┌─────────────────────────────────────────────────────────────────────┐
│ 1단계: 요청 분석 및 목표 설정                    ⏱️ 시간 기록 시작   │
│        ├ 1-1. 요청 내용/의도 파악                                   │
│        ├ 1-2. 필수 정보 간략 확인 (CLAUDE.md 등)                    │
│        ├ 1-3. 목표 설정 및 성공 기준 정의                           │
│        ├ 1-4. 목표 달성 계획안 작성                                 │
│        └ 1-5. 정보 수집 목록 작성                                   │
├─────────────────────────────────────────────────────────────────────┤
│ 2단계: 정보 수집                                 ⏱️ 각 호출별 기록   │
│        ├ 2-1. 프로젝트 전체 구조 수집                               │
│        ├ 2-2. 요청 항목 상세 수집                                   │
│        ├ 2-3. 파일별 import 문 수집 (raw data)                      │
│        ├ 2-4. 각 파일/폴더 역할 설명                                │
│        └ ⚡ 독립 항목 3개+ 시 Setter 병렬 실행                       │
├─────────────────────────────────────────────────────────────────────┤
│ 3단계: 정보 분석 및 상세 계획 수립               ⏱️ 분석 시간 기록   │
│        ├ 3-1. 수집 정보 분석                                       │
│        ├ 3-2. 포함/제외 목록 결정                                   │
│        ├ 3-3. ⭐ import 의존성 검증 (파일 복사/이동 시 필수)         │
│        ├ 3-4. 상세 실행 계획 수립                                   │
│        └ 3-5. Advisor 계획 검토                                     │
├─────────────────────────────────────────────────────────────────────┤
│ 4단계: 실행                                      ⏱️ 각 작업별 기록   │
│        ├ 4-1. Supervisor에게 작업 분배                              │
│        ├ 4-2. Executor 실행 (병렬/순차)                             │
│        └ 4-3. 결과 검수 및 취합                                     │
├─────────────────────────────────────────────────────────────────────┤
│ 5단계: 실행 분석 보고                            📊 보고서 출력      │
│        ├ 5-1. 시간 기록 취합                                       │
│        ├ 5-2. 병목 단계 식별                                       │
│        ├ 5-3. 병목 원인 분석 (담당자 인터뷰 또는 직접 분석)          │
│        ├ 5-4. 보고서 생성 (콘솔 + JSON)                             │
│        └ 5-5. 개선 제안                                            │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 1단계: 요청 분석

Setter 호출 **전에** 수행:

1. **요청 내용/의도 파악** - 사용자가 원하는 것 명확히 정의
2. **필수 정보 간략 확인** - CLAUDE.md, README.md, 프로젝트 구조
3. **목표 설정** - 최종 목표 정의, 성공 기준 명시
4. **목표 달성 계획안 작성** - 대략적인 접근 방식
5. **정보 수집 목록 작성** - Setter에게 전달할 구체적 항목

---

## 2단계: 정보 수집 (Setter)

> **핵심: 깊은 분석 없이 수집 + 역할 설명**

- 프로젝트 전체 파일 구조 + **각 디렉토리/파일의 역할 설명**
- 관련 파일 경로 및 내용 + **기능/역할 설명**
- **파일별 import 문 수집** (raw data로 전달)

> **주의:** 코드 패턴 분석, 통합 방안 검토, 포함/제외 판단 등 깊은 분석은 하지 않음.

### 병렬 실행 전략

수집 항목이 **3개 이상**이고 **서로 독립적**인 경우, 병렬로 Setter 호출:

```
판단 기준:
├ 독립적: 서로 다른 폴더/모듈 조사 → 병렬 가능
├ 의존적: A 결과가 B 수집에 필요 → 순차 실행
└ 혼합: 독립 항목끼리 병렬, 의존 항목은 순차
```

| 항목 수 | 전략 |
|---------|------|
| 1~2개 | 단일 Setter |
| 3~5개 | 2~3개 Setter 병렬 |
| 6개+ | 주제별로 그룹화 후 병렬 |

**템플릿:** [templates/setter.md](./templates/setter.md)

---

## 3단계: 분석 및 계획 (Orchestrator)

1. **수집 정보 분석** - 코드 패턴 파악, 기존 구조와 통합 방안
2. **포함/제외 목록 결정** - 어떤 파일을 포함/제외할지 결정
3. **⭐ import 의존성 검증** (파일 복사/이동 시 필수)
   - 포함 대상이 제외 대상을 import하는지 확인
   - 누락 발견 시 → 포함 목록 수정 또는 stub 생성
4. **추가 정보 필요 여부** - 부족 시 Setter 재호출
5. **상세 계획 수립**

### 상세 계획 포맷

```markdown
## 상세 계획

### 1. 목표
- 최종 목표: {목표}
- 성공 기준: {기준}

### 2. 작업 분할

| 작업 ID | 작업 내용 | 담당 | 의존성 | 병렬 가능 |
|---------|----------|------|--------|----------|
| T1 | {작업1} | 감독관A | 없음 | O |
| T2 | {작업2} | 감독관A | T1 | X |

### 3. 병렬 처리 전략
- 1차 병렬 (감독관 레벨): 감독관A: T1, T2 / 감독관B: T3, T4
- 2차 병렬 (실행자 레벨): 각 감독관 → 실행자 N명

### 4. 의존성 순서
T1, T2 (병렬) → T3 (순차) → T4, T5 (병렬)
```

---

## 4단계: 실행

### 위임 기준

| 조건 | 처리 |
|------|------|
| 단순 반복 1~2개 | 직접 실행 |
| 단순 반복 3개+ | Executor 병렬 위임 |
| 복잡한 판단 | 직접 |
| 계획 검토 | Advisor (계획 단계만) |

**병렬 실행 조건:** 의존성 없음 + 같은 파일 수정 아님

**템플릿:** [templates/executor.md](./templates/executor.md)

---

## 5단계: 실행 분석 (Analyzer) - 필수

> **이 단계는 선택이 아닌 필수입니다.**

### 필수 수행 항목

| 순서 | 항목 | 필수 여부 |
|------|------|----------|
| 5-1 | 시간 기록 취합 | ✅ 필수 |
| 5-2 | 병목 단계 식별 | ✅ 필수 |
| 5-3 | 병목 원인 분석 | ✅ 필수 |
| 5-4 | 병렬 실행 효율성 분석 | ✅ 필수 |
| 5-5 | Orchestrator와 프로세스 개선 논의 | ✅ 필수 |
| 5-6 | 콘솔 보고서 출력 | ✅ 필수 |
| 5-7 | JSON 파일 저장 | ✅ 필수 |

### 시간 기록 형식

```
[TIME] {단계}.{작업ID} | {START/END} | {timestamp} | {설명}
```

예시:
```
[TIME] 1.0 | START | 2024-01-19 10:00:00 | 1단계: 요청 분석 시작
[TIME] 1.0 | END   | 2024-01-19 10:00:30 | 1단계: 요청 분석 완료 (30s)
[TIME] 2.1 | START | 2024-01-19 10:00:30 | Setter 호출 시작
```

### 병목 판단 기준

| 비율 | 판정 |
|------|------|
| 50% 이상 | 🔴 심각한 병목 |
| 30~50% | 🟡 주의 필요 |
| 30% 미만 | 🟢 정상 |

### 병렬 효율성 판정

| 효율성 | 판정 |
|--------|------|
| 2.0x 이상 | 🟢 우수 |
| 1.5x ~ 2.0x | 🟡 양호 |
| 1.5x 미만 | 🔴 미흡 |

### 보고서 저장

```
~/.claude/orchestration/reports/{YYYY-MM-DD}_{HH-mm-ss}.json
```

**상세 템플릿:**
- 콘솔 보고서: [templates/execution-report.md](./templates/execution-report.md)
- JSON 스키마: [templates/analyzer.md](./templates/analyzer.md)

---

## 핵심 원칙

1. **오케스트레이션 시작 시 반드시 `_index.md` → `instruction.md` 읽기**
2. Orchestrator는 Setter 호출 전에 먼저 요청 분석 및 목표 설정
3. Setter는 **수집 + 역할 설명**, 깊은 분석은 Orchestrator가 수행
4. 정보 부족 시 Setter 반복 호출
5. Advisor는 계획 단계에서만 사용 (실행 단계 금지)
6. 감독관은 책임지고 검수
7. 실행자는 판단 없이 실행만
8. subagent 생성 비용 > 실행 비용이면 직접 처리
9. **1단계 시작부터 모든 단계/작업의 시간을 기록**
10. **5단계 실행 분석 보고 완료 전까지 오케스트레이션 미완료**
11. **5단계에서 반드시 콘솔 보고서 출력 + JSON 저장**

---

## 템플릿

| 템플릿 | 용도 |
|--------|------|
| [`setter.md`](./templates/setter.md) | 정보 수집 |
| [`executor.md`](./templates/executor.md) | git, shell 명령 |
| [`file-processor.md`](./templates/file-processor.md) | 파일 처리 |
| [`analyzer.md`](./templates/analyzer.md) | 실행 시간 분석, JSON 스키마 |
| [`execution-report.md`](./templates/execution-report.md) | 콘솔 보고서 출력 (5단계) |

## 참고

- 설정: [config.md](./config.md)
